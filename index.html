<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="screen-orientation" content="portrait">
    <meta name="full-screen" content="yes">
    <meta name="browsermode" content="application">
    <meta name="x5-orientation" content="portrait">
    <meta name="x5-fullscreen" content="true">
    <meta name="x5-page-mode" content="app">
    <title>RealTech 即時地震速報</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --background-dark: #111827;
            --background-light: #1f2937;
            --text-light: #f3f4f6;
            --text-muted: #9ca3af;
            --border-dark: #374151;
            --shadow-color: rgba(0, 0, 0, 0.25);
            --transition: all 0.3s ease;
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --animation-speed: 0.3s;
            --animation-easing: cubic-bezier(0.4, 0, 0.2, 1);
            --hover-transform: scale(1.02);
            --active-transform: scale(0.98);
        }

        body, html {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: var(--background-dark);
            color: var(--text-light);
            overflow: hidden;
        }

        #app-container {
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #map {
            flex: 1;
            width: 100%;
            background: var(--background-dark);
            z-index: 1;
        }

        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: rgba(17, 24, 39, 0.8);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-dark);
            backdrop-filter: blur(20px);
            animation: slideUp var(--animation-speed) var(--animation-easing);
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .action-button {
            padding: 8px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.05);
            border: none;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-light);
        }

        .time-display {
            position: absolute;
            top: 80px;
            left: 20px;
            color: var(--text-light);
            font-size: 18px;
            font-weight: 500;
            z-index: 1000;
        }

        .elapsed-time {
            position: absolute;
            top: 110px;
            left: 20px;
            color: #00ff00;
            font-size: 16px;
            z-index: 1000;
        }

        .info-card {
            position: absolute;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: 400px;
            background: var(--background-dark);
            border-radius: var(--radius-md);
            padding: 20px;
            box-shadow: 0 4px 6px var(--shadow-color);
            z-index: 1000;
            transition: var(--transition);
            border: 1px solid var(--border-dark);
        }

        .info-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .info-card-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .info-value {
            font-size: 1rem;
            font-weight: 500;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--background-dark);
            padding: 12px 24px;
            border-top: 1px solid var(--border-dark);
            z-index: 1000;
            display: flex;
            justify-content: space-around;
            align-items: center;
            backdrop-filter: blur(10px);
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border-radius: var(--radius-md);
            color: var(--text-light);
            cursor: pointer;
            transition: transform var(--animation-speed) var(--animation-easing),
                        background-color var(--animation-speed) var(--animation-easing);
        }

        .nav-item.active {
            background: var(--primary-color);
        }

        .nav-icon {
            font-size: 20px;
        }

        .nav-label {
            font-size: 12px;
            font-weight: 500;
        }

        .nav-item:hover {
            transform: var(--hover-transform);
        }

        .nav-item:active {
            transform: var(--active-transform);
        }

        .station-marker {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--primary-color);
            border: none;
            box-shadow: 0 0 4px var(--primary-color);
            position: relative;
            overflow: hidden;
            transition: all var(--animation-speed) var(--animation-easing);
        }

        .station-marker-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            transition: width 1s ease;
        }

        .station-label {
            background: none;
            border: none;
            box-shadow: none;
            color: white;
            font-size: 10px;
            font-weight: bold;
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.8);
            white-space: nowrap;
            transform: translate(-50%, -150%);
            position: absolute;
            top: 0;
            transition: opacity 0.3s ease;
        }

        #settings-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100vh;
            background: var(--background-dark);
            z-index: 2000;
            transition: var(--transition);
            padding: 24px;
            overflow-y: auto;
            display: none;
            box-sizing: border-box;
        }

        #settings-panel.open {
            right: 0;
            display: block;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .settings-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .settings-close {
            padding: 8px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.05);
            border: none;
            cursor: pointer;
            color: var(--text-light);
        }

        .settings-section {
            margin-bottom: 24px;
            padding-bottom: 24px;
        }

        .settings-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .settings-item {
            min-height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
            margin-bottom: 12px;
        }

        .settings-item-label {
            font-weight: 500;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
            opacity: 0.9;
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        .settings-select {
            padding: 8px 12px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-dark);
            background-color: var(--background-dark);
            color: var(--text-light);
            font-size: 14px;
            width: 100px;
        }

        .dark-mode .settings-select {
            background-color: var(--background-dark);
            color: var(--text-dark);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .report-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: calc(100% - 70px);
            overflow: hidden;
        }

        .report-filters {
            padding: 15px;
            background: var(--background-dark);
            border-bottom: 1px solid var(--border-dark);
        }

        #report-map {
            height: 200px;
            width: 100%;
            flex-shrink: 0;
        }

        #report-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .report-item {
            background: var(--background-dark);
            border: 1px solid var(--border-dark);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 16px;
            align-items: center;
        }

        .report-intensity {
            font-size: 1.2rem;
            font-weight: 700;
            color: #f87171;
            min-width: 45px;
            text-align: center;
        }

        .report-main {
            overflow: hidden;
        }

        .report-location {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .report-time {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.5);
            white-space: nowrap;
        }

        .intensity-icon {
            width: 24px;
            height: 24px;
            vertical-align: middle;
            margin-right: 8px;
        }

        .intensity-info {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .alert-container {
            position: fixed;
            bottom: 90px;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 2000;
            padding: 0 16px;
        }

        .alert-box {
            width: 100%;
            max-width: 800px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: var(--radius-md);
            margin-bottom: 12px;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 20px;
            animation: slideUp var(--animation-speed) var(--animation-easing);
            transition: transform var(--animation-speed) var(--animation-easing),
                        opacity var(--animation-speed) var(--animation-easing);
        }

        .alert-box:hover {
            transform: var(--hover-transform);
        }

        .alert-intensity {
            width: 80px;
            height: 80px;
            background: #ffcc00;
            border-radius: var(--radius-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .alert-intensity-value {
            font-size: 36px;
            line-height: 1;
        }

        .alert-intensity-label {
            font-size: 14px;
            margin-top: 4px;
        }

        .alert-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 8px;
        }

        .alert-location {
            font-size: 24px;
            font-weight: bold;
        }

        .alert-details {
            font-size: 16px;
            opacity: 0.9;
        }

        .alert-time {
            font-size: 14px;
            opacity: 0.7;
        }

        .no-alert-message {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: var(--radius-md);
            backdrop-filter: blur(8px);
            z-index: 1999;
            font-size: 14px;
            white-space: nowrap;
        }

        @keyframes slideInFromBottom {
            0% {
                transform: translateY(100%);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .alert-icon {
            font-size: 24px;
            color: rgba(255, 255, 255, 0.9);
            animation: pulseAndRotate 2s infinite;
            flex-shrink: 0;
        }

        .alert-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .alert-message {
            font-size: 14px;
            line-height: 1.5;
            opacity: 0.95;
            margin-bottom: 4px;
        }

        .alert-close {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            font-size: 12px;
        }

        .eew-area-container {
            position: absolute;
            bottom: 90px;
            left: 0;
            right: 0;
            background: rgba(220, 38, 38, 0.95);
            color: white;
            padding: 12px 24px;
            font-size: 14px;
            text-align: center;
            z-index: 1000;
            display: none;
        }

        .intensity-value {
            font-size: 24px;
            font-weight: 700;
            color: #ff3333;
        }

        .intensity-label {
            font-size: 12px;
            color: var(--text-light);
            opacity: 0.7;
        }

        .report-details {
            font-size: 14px;
            color: var(--text-light);
            opacity: 0.8;
            margin-top: 4px;
        }

        .test-button {
            padding: 8px 16px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 14px;
        }

        .test-button:hover {
            opacity: 0.9;
        }

        .settings-section:last-child {
            margin-bottom: 80px;
        }

        /* 震度圖層的樣式 */
        .intensity-circle {
            transition: all 0.3s ease;
        }

        .intensity-circle:hover {
            fillOpacity: 0.6;
        }

        .epicenter-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .earthquake-info {
            position: absolute;
            top: 70px;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            z-index: 1000;
            text-align: center;
            backdrop-filter: blur(8px);
        }

        .earthquake-info-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .earthquake-info-details {
            font-size: 14px;
            line-height: 1.4;
        }

        .test-buttons {
            display: flex;
            gap: 8px;
        }

        .test-button-stop {
            background: #dc2626;
        }

        .test-button-stop:hover {
            background: #b91c1c;
        }

        .dev-output {
            position: fixed;
            bottom: 90px;
            right: 16px;
            width: 300px;
            max-height: 200px;
            background: rgba(0, 0, 0, 0.85);
            color: #00ff00;
            padding: 12px;
            border-radius: var(--radius-md);
            font-family: 'Consolas', monospace;
            font-size: 12px;
            line-height: 1.4;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .dev-output.show {
            display: block;
        }

        .dev-output-line {
            margin-bottom: 4px;
            word-wrap: break-word;
            opacity: 0.9;
        }

        .dev-output-line.error {
            color: #ff4444;
        }

        .dev-output-line.warning {
            color: #ffaa00;
        }

        .dev-output-line.success {
            color: #44ff44;
        }

        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(20, 20, 20, 0.95) 100%);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
            pointer-events: auto;
            margin: 0;
            padding: 0;
        }

        .login-box {
            background: rgba(30, 30, 30, 0.9);
            padding: 24px;
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: fadeIn var(--animation-speed) var(--animation-easing);
            position: relative;
            margin: auto;
            z-index: 3001;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .login-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-color);
            border-radius: var(--radius-md);
            font-size: 40px;
            color: white;
            position: relative;
        }

        .login-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            color: white;
        }

        .login-subtitle {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 24px;
            font-size: 14px;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            border-radius: var(--radius-md);
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            transition: all 0.3s;
            font-size: 14px;
            box-sizing: border-box;
        }

        .login-input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.2);
        }

        .login-button {
            width: 100%;
            padding: 12px;
            border-radius: var(--radius-md);
            border: none;
            background: var(--primary-color);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all var(--animation-speed) var(--animation-easing);
            font-size: 16px;
            height: 48px;
            margin-top: 8px;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
        }

        .login-button:hover {
            background: #0052cc;
            transform: translateY(-1px);
        }

        .login-button:active {
            transform: translateY(1px);
        }

        .login-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease-out, height 0.6s ease-out;
        }

        .login-button:active::after {
            width: 300px;
            height: 300px;
            opacity: 0;
        }

        .login-error {
            color: #ff4444;
            font-size: 14px;
            text-align: center;
            margin-top: 16px;
            display: none;
        }

        .logout-button {
            background: #dc2626;
            margin-top: 12px;
        }

        .logout-button:hover {
            background: #b91c1c;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.5);
                opacity: 0.7;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .version-info {
            position: fixed;
            bottom: 85px;
            left: 10px;
            color: var(--text-muted);
            font-size: 0.75rem;
            z-index: 999;
            opacity: 0.8;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            background-color: rgba(17, 24, 39, 0.6);
            padding: 4px 8px;
            border-radius: 4px;
            backdrop-filter: blur(4px);
        }

        /* 確保在小螢幕上也能看到版本號 */
        @media screen and (max-height: 600px) {
            .version-info {
                bottom: 65px;
                left: 5px;
                font-size: 0.7rem;
                padding: 2px 6px;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div class="alert-container" id="alert-container"></div>
        <header class="header">
            <h1 class="header-title">RealTech 即時地震速報</h1>
            <div class="header-actions">
                <button class="action-button" id="refresh-btn">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="action-button" id="location-btn">
                    <i class="fas fa-location-arrow"></i>
                </button>
            </div>
        </header>

        <div id="map"></div>

        <div class="info-card" style="display: none;">
            <div class="info-card-header">
                <h3 class="info-card-title">測站資訊</h3>
                <button class="action-button" id="close-info">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">位置</span>
                    <span class="info-value" id="station-location">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">測站代號</span>
                    <span class="info-value" id="station-id">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">PGA</span>
                    <span class="info-value" id="station-pga">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">PGV</span>
                    <span class="info-value" id="station-pgv">-</span>
                </div>
            </div>
        </div>

        <nav class="bottom-nav">
            <div class="nav-item active">
                <i class="nav-icon fas fa-map-marked-alt"></i>
                <span class="nav-label">地圖</span>
            </div>
            <div class="nav-item">
                <i class="nav-icon fas fa-cog"></i>
                <span class="nav-label">設置</span>
            </div>
        </nav>

        <div id="settings-panel">
            <div class="settings-header">
                <h2 class="settings-title">設置</h2>
                <button class="settings-close" id="close-settings">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="settings-section">
                <h3 class="settings-section-title">顯示設置</h3>
                <div class="settings-item">
                    <span class="settings-item-label">自動更新</span>
                    <label class="switch">
                        <input type="checkbox" id="auto-update-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span class="settings-item-label">顯示 PGA 數值</span>
                    <label class="switch">
                        <input type="checkbox" id="show-pga-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div class="settings-section">
                <h3 class="settings-section-title">測試功能</h3>
                <div class="settings-item">
                    <span class="settings-item-label">地震警報測試</span>
                    <div class="test-buttons">
                        <button class="test-button" id="test-warning-btn">開始測試</button>
                        <button class="test-button test-button-stop" id="stop-test-btn" style="display: none;">結束測試</button>
                </div>
            </div>
        </div>
            <div class="settings-section">
                <h3 class="settings-section-title">開發者選項</h3>
                <div class="settings-item">
                    <span class="settings-item-label">開發者模式</span>
                    <label class="switch">
                        <input type="checkbox" id="dev-mode-toggle">
                        <span class="slider"></span>
                    </label>
            </div>
                    </div>
            <div class="settings-section">
                <h3 class="settings-section-title">帳號設置</h3>
                <div class="settings-item">
                    <span class="settings-item-label">目前帳號</span>
                    <span id="current-user">-</span>
                </div>
                <div class="settings-item">
                    <button class="login-button logout-button" onclick="logout()">登出</button>
                </div>
            </div>
        </div>

        <div class="earthquake-info" id="earthquake-info" style="display: none;">
            <div class="earthquake-info-content">
                <div class="earthquake-info-title">地震資訊</div>
                <div class="earthquake-info-details" id="earthquake-info-details"></div>
            </div>
            </div>

        <div id="dev-output" class="dev-output"></div>

        <div id="login-overlay" class="login-overlay" style="display: none;">
            <div class="login-box">
                <div class="login-logo">
                    <i class="fas fa-broadcast-tower"></i>
        </div>
                <div class="login-title">RealTech 即時地震速報</div>
                <div class="login-subtitle">請登入以使用系統功能</div>
                <input type="text" id="username" class="login-input" placeholder="請輸入帳號" autocomplete="username">
                <input type="password" id="password" class="login-input" placeholder="請輸入密碼" autocomplete="current-password">
                <button class="login-button" onclick="login()">登入</button>
                <div id="login-error" class="login-error"></div>
            </div>
        </div>

        <div class="version-info">v0.0.2 alpha</div>
    </div>

    <script>
        let map;
        let markers = {};
        let updateInterval;
        let isAutoUpdateEnabled = true;
        let showPGAValue = false;
        let markerSize = 'small';
        let reportMap;
        let reportMarkers = [];
        let allEarthquakeReports = [];
        let lastPingTime = 0;
        let currentPing = 0;
        let intensityLayer = null;
        let waveAnimationInterval = null;
        let pWaveCircle = null;
        let sWaveCircle = null;
        let isTestMode = false;
        let isDevMode = false;

        // 用戶資料
        const users = {
            'RT_ADMIN_1': {
                password: 'realtecheew',
                isAdmin: true
            },
            'DT': {
                password: '11111111',
                isAdmin: false
            }
        };

        let currentUser = null;

        // WebView 相關變量
        const isWebView = navigator.userAgent.includes('wv') || 
                          navigator.userAgent.includes('WebView');
        const androidInterface = window.Android || null;
        const webViewReady = new Promise((resolve) => {
            if (isWebView) {
                document.addEventListener('WebViewReady', () => resolve(true));
                // 5秒後超時
                setTimeout(() => resolve(false), 5000);
            } else {
                resolve(true);
            }
        });

        // 添加簡單的調試工具
        const Debug = {
            log: function(msg, type = 'info') {
                const time = new Date().toLocaleTimeString();
                console.log(`[${time}][${type.toUpperCase()}] ${msg}`);
                
                if (isDevMode) {
                    const output = document.getElementById('dev-output');
                    if (output) {
                        const line = document.createElement('div');
                        line.className = `dev-output-line ${type}`;
                        line.textContent = `[${time}] ${msg}`;
                        output.appendChild(line);
                        output.scrollTop = output.scrollHeight;
                    }
                }
            },
            
            error: function(error) {
                this.log(error.message || error, 'error');
                console.error(error);
            }
        };

        function initializeMap() {
            map = L.map('map', {
                center: [23.5, 121],
                zoom: 7,
                zoomControl: false,
                attributionControl: false,
                preferCanvas: true,
                minZoom: 6,
                maxZoom: 12
            });

            // 使用深色地圖
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19,
                minZoom: 3
            }).addTo(map);

            // 添加縣市邊界
            fetch('https://raw.githubusercontent.com/g0v/twgeojson/master/json/twCounty2010.geo.json')
                .then(response => response.json())
                .then(data => {
                    L.geoJSON(data, {
                        style: {
                            color: '#333333',
                            weight: 1,
                            fillOpacity: 0
                        }
                    }).addTo(map);
                });

            // 添加時間顯示
            const timeDisplay = document.createElement('div');
            timeDisplay.className = 'time-display';
            document.getElementById('app-container').appendChild(timeDisplay);

            const elapsedTime = document.createElement('div');
            elapsedTime.className = 'elapsed-time';
            elapsedTime.textContent = 'Connecting...';
            document.getElementById('app-container').appendChild(elapsedTime);

            // 添加無警報提示
            const noWarning = document.createElement('div');
            noWarning.className = 'no-warning-container';
            noWarning.textContent = 'No active earthquake warnings';
            document.getElementById('app-container').appendChild(noWarning);

            updateTime();
            setInterval(updateTime, 1000);
        }

        function updateTime() {
            const now = new Date();
            const timeDisplay = document.querySelector('.time-display');
            const elapsedTime = document.querySelector('.elapsed-time');
            
            if (timeDisplay) {
                timeDisplay.textContent = now.toLocaleString('en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
            }

            if (elapsedTime) {
                const delay = ((Date.now() - lastPingTime) / 1000).toFixed(2);
                elapsedTime.textContent = `${delay}s`;
                elapsedTime.style.color = delay < 1 ? '#00ff00' : '#ff0000';
            }
        }

        function extractStationId(fullId) {
            const match = fullId.match(/\d+-(\d+)-\d+/);
            return match ? match[1] : null;
        }

        function getMarkerSize() {
            return 8;  // 固定返回 8px
        }

        function createStationMarker(station, fullStationId) {
            const stationId = extractStationId(fullStationId);
            if (!stationId) {
                console.warn(`無法從 ${fullStationId} 提取有效的測站代號`);
                return null;
            }

            const icon = L.divIcon({
                html: `<div class="station-marker" style="background-color: var(--primary-color); width: 6px; height: 6px;"></div>`,
                className: '',
                iconSize: [6, 6]
            });

            const marker = L.marker([station.Lat, station.Long], {icon: icon}).addTo(map);
            
            marker.on('click', function() {
                showStationInfo(station, stationId);
            });

            return { marker, stationId };
        }

        function showStationInfo(station, stationId) {
            const infoCard = document.querySelector('.info-card');
            document.getElementById('station-location').textContent = station.Loc;
            document.getElementById('station-id').textContent = stationId;
            
            const markerData = markers[stationId];
            if (markerData && markerData.tremor) {
                document.getElementById('station-pga').textContent = `${markerData.tremor.pga.toFixed(2)} gal`;
                document.getElementById('station-pgv').textContent = `${markerData.tremor.pgv.toFixed(2)} kine`;
            } else {
                document.getElementById('station-pga').textContent = '-';
                document.getElementById('station-pgv').textContent = '-';
            }
            
            infoCard.style.display = 'block';
        }

        async function fetchStations() {
            try {
                Debug.log('開始獲取測站資料...');
                const response = await fetch('https://raw.githubusercontent.com/ExpTechTW/API/master/Json/earthquake/station.json');
                const data = await response.json();
                
                Debug.log(`接收到 ${Object.keys(data).length} 個測站的資料`);
                for (let fullStationId in data) {
                    const station = data[fullStationId];
                    const markerData = createStationMarker(station, fullStationId);
                    if (markerData) {
                        markers[markerData.stationId] = {
                            data: station,
                            ...markerData
                        };
                    }
                }
                startEarthquakeDataFetching();
            } catch (error) {
                Debug.error(`錯誤：無法獲取測站資料 - ${error.message}`);
            }
        }

        async function updateEarthquakeData() {
            if (!isAutoUpdateEnabled) return;
            
            const startTime = performance.now();
            
            try {
                const response = await fetch('https://lb-2.exptech.dev/api/v1/trem/rts');
                const data = await response.json();
                
                if (data.station) {
                    // 批量更新所有測站
                    const updates = [];
                    for (let stationId in data.station) {
                        if (markers[stationId]) {
                            const tremor = data.station[stationId];
                            const marker = markers[stationId];
                            marker.tremor = tremor;
                            
                            const pga = parseFloat(tremor.pga);
                            if (!isNaN(pga)) {
                                let color;
                                if (pga > 400) color = '#4B0091';      // 7級以上
                                else if (pga > 250) color = '#9932CC';  // 6-7級
                                else if (pga > 140) color = '#FF0000';  // 5-6級
                                else if (pga > 80) color = '#FF4500';   // 4.5-5級
                                else if (pga > 25) color = '#FFA500';   // 4-4.5級
                                else if (pga > 15) color = '#FFD700';   // 3.5-4級
                                else if (pga > 8) color = '#FFFF00';    // 3-3.5級
                                else if (pga > 5) color = '#ADFF2F';    // 2.5-3級
                                else if (pga > 2) color = '#32CD32';    // 2-2.5級
                                else if (pga > 1) color = '#00FF7F';    // 1.5-2級
                                else if (pga > 0.5) color = '#00FFFF';  // 1-1.5級
                                else color = '#87CEEB';                 // 1級以下

                                const size = 6;
                                const markerHtml = `
                                    <div class="station-marker" style="
                                        background-color: ${color};
                                        box-shadow: 0 0 4px ${color};
                                        width: ${size}px;
                                        height: ${size}px;
                                    ">
                                        ${showPGAValue && pga > 0.5 ? 
                                            `<div class="station-label" style="color: white;">${pga.toFixed(1)}</div>` 
                                            : ''}
                                    </div>
                                `;

                                updates.push(() => {
                                marker.marker.setIcon(L.divIcon({
                                        html: markerHtml,
                                    className: '',
                                    iconSize: [size, size]
                                }));
                                });
                            }
                        }
                    }
                    // 一次性執行所有更新
                    updates.forEach(update => update());
                }

                const endTime = performance.now();
                currentPing = Math.round(endTime - startTime);
                lastPingTime = Date.now();

            } catch (error) {
                Debug.error('更新數據失敗: ' + error.message);
                devLog('更新數據失敗: ' + error.message, 'error');
            }
        }

        function startEarthquakeDataFetching() {
            updateEarthquakeData();
            updateInterval = setInterval(updateEarthquakeData, 1000);
        }

        function initializeUIHandlers() {
            // 關閉信息卡片
            document.getElementById('close-info').addEventListener('click', () => {
                document.querySelector('.info-card').style.display = 'none';
            });

            // 刷新按鈕
            document.getElementById('refresh-btn').addEventListener('click', () => {
                updateEarthquakeData();
            });

            // 定位按鈕
            document.getElementById('location-btn').addEventListener('click', () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            map.setView([position.coords.latitude, position.coords.longitude], 12);
                        },
                        (error) => {
                            Debug.error('無法獲取置: ' + error.message);
                        }
                    );
                }
            });

            // 底部導航
            document.querySelectorAll('.nav-item').forEach((item) => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    const settingsPanel = document.getElementById('settings-panel');
                    
                    if (item.querySelector('.fa-cog')) {
                        settingsPanel.style.display = 'block';
                        setTimeout(() => {
                            settingsPanel.classList.add('open');
                        }, 10);
                    } else {
                        settingsPanel.classList.remove('open');
                        setTimeout(() => {
                            settingsPanel.style.display = 'none';
                        }, 300);
                        map.invalidateSize();
                    }
                });
            });

            // 關閉設置面板
            document.getElementById('close-settings').addEventListener('click', () => {
                const settingsPanel = document.getElementById('settings-panel');
                settingsPanel.classList.remove('open');
                setTimeout(() => {
                    settingsPanel.style.display = 'none';
                }, 300);
                document.querySelector('.nav-item:first-child').click();
            });

            // 自動更新切換
            const autoUpdateToggle = document.getElementById('auto-update-toggle');
            autoUpdateToggle.addEventListener('change', (e) => {
                isAutoUpdateEnabled = e.target.checked;
                if (isAutoUpdateEnabled) {
                    startEarthquakeDataFetching();
                } else {
                    clearInterval(updateInterval);
                }
            });

            // PGA 數值顯示切換
            const showPGAToggle = document.getElementById('show-pga-toggle');
            showPGAToggle.checked = localStorage.getItem('showPGAValue') === 'true';
            showPGAValue = showPGAToggle.checked;
            showPGAToggle.addEventListener('change', (e) => {
                showPGAValue = e.target.checked;
                localStorage.setItem('showPGAValue', showPGAValue);
                updateEarthquakeData(); // 立即更新顯示
            });

            // 測試按鈕
            const testButton = document.getElementById('test-warning-btn');
            const stopTestButton = document.getElementById('stop-test-btn');
            
            if (testButton && stopTestButton) {
                testButton.addEventListener('click', () => {
                    Debug.log('開始測試模式', 'warning');
                    isTestMode = true;
                    testButton.style.display = 'none';
                    stopTestButton.style.display = 'block';
                    
                    // 清除現有的警報和圖層
                    clearExistingLayers();
                    const alertContainer = document.getElementById('alert-container');
                    alertContainer.innerHTML = '';
                    
                    // 測試地震的震央位置
                    const testEpicenter = {
                        lat: 23.72,
                        lon: 121.45
                    };
                    
                    // 準備測站更新
                    const updates = [];
                    for (let stationId in markers) {
                        const marker = markers[stationId];
                        // 計算測站到震央的距離（公里）
                        const station = marker.data;
                        const distance = calculateDistance(
                            testEpicenter.lat, testEpicenter.lon,
                            station.Lat, station.Long
                        );
                        
                        // 根據距離決定震度
                        let intensity = 0;
                        let pga = 0;
                        if (distance < 30) {
                            intensity = 5;
                            pga = 120 + Math.random() * 20;
                        } else if (distance < 50) {
                            intensity = 4;
                            pga = 80 + Math.random() * 20;
                        } else if (distance < 80) {
                            intensity = 3;
                            pga = 40 + Math.random() * 20;
                        }
                        
                        // 根據震度決定顏色
                        let color;
                        if (intensity === 5) color = '#FF0000';
                        else if (intensity === 4) color = '#FFA500';
                        else if (intensity === 3) color = '#FFD700';
                        else color = 'var(--primary-color)';

                        const size = 6;
                        const markerHtml = `
                            <div class="station-marker" style="
                                background-color: ${color};
                                box-shadow: 0 0 4px ${color};
                                width: ${size}px;
                                height: ${size}px;
                            ">
                                ${showPGAValue && pga > 0.5 ? `<div class="station-label" style="color: white;">${pga.toFixed(1)}</div>` : ''}
                            </div>
                        `;
                        
                        // 延遲更新，模擬地震波傳播
                        const delay = Math.round(distance * 100); // 根據距離計算延遲
                        updates.push(() => {
                            setTimeout(() => {
                                marker.marker.setIcon(L.divIcon({
                                    html: markerHtml,
                                    className: '',
                                    iconSize: [size, size]
                                }));
                            }, delay);
                        });
                    }

                    // 顯示測試警報
                    const testEEW = {
                        id: "test" + Date.now(),
                        serial: 1,
                        final: false,
                        eq: {
                            time: Date.now(),
                            lon: 121.45,
                            lat: 23.72,
                            depth: 24,
                            mag: 5.1,
                            loc: "花蓮縣鳳林鎮",
                            max: 5,
                            area: {
                                "4": ["花蓮縣鳳林鎮", "花蓮縣光復鄉"],
                                "5": ["花蓮縣秀林鄉"]
                            }
                        }
                    };
                    showEEWAlert(testEEW);
                });

                stopTestButton.addEventListener('click', () => {
                    Debug.log('結束測試模式', 'warning');
                    isTestMode = false;
                    stopTestButton.style.display = 'none';
                    testButton.style.display = 'block';
                    
                    // 清除所有測試相關的顯示
                    clearExistingLayers();
                    const alertContainer = document.getElementById('alert-container');
                    alertContainer.innerHTML = '';
                    document.getElementById('earthquake-info').style.display = 'none';
                    
                    // 顯示無地震速報提示
                    document.getElementById('no-alert-message').style.display = 'block';
                    
                    // 重置所有測站顏色
                    for (let stationId in markers) {
                        const marker = markers[stationId].marker;
                        marker.setIcon(L.divIcon({
                            html: `<div class="station-marker" style="background-color: var(--primary-color);"></div>`,
                            className: '',
                            iconSize: [6, 6]
                        }));
                    }
                    
                    // 延遲一下再重新開始接收數據
                    setTimeout(() => {
                        updateEarthquakeData();
                    }, 100);
                });
            }

            // 開發者模式切換
            const devModeToggle = document.getElementById('dev-mode-toggle');
            devModeToggle.checked = localStorage.getItem('devMode') === 'true';
            isDevMode = devModeToggle.checked;
            document.getElementById('dev-output').classList.toggle('show', isDevMode);
            
            devModeToggle.addEventListener('change', (e) => {
                if (!currentUser?.isAdmin) {
                    e.target.checked = false;
                    Debug.error('只有管理員可以使用開發者模式');
                    return;
                }
                isDevMode = e.target.checked;
                localStorage.setItem('devMode', isDevMode);
                document.getElementById('dev-output').classList.toggle('show', isDevMode);
                devLog('開發者模式 ' + (isDevMode ? '開啟' : '關閉'));
            });
        }

        async function initialize() {
            try {
                Debug.log('開始初始化');
                
                // 等待 WebView 準備就緒
                await webViewReady;
                Debug.log('WebView 就緒');

                if (isWebView) {
                    Debug.log('設置 WebView 環境');
                    // 禁用所有瀏覽器默認行為
                    document.addEventListener('touchstart', (e) => e.preventDefault(), { passive: false });
                    document.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
                    document.addEventListener('touchend', (e) => e.preventDefault(), { passive: false });
                    document.addEventListener('contextmenu', (e) => e.preventDefault());
                    document.addEventListener('dblclick', (e) => e.preventDefault());
                    
                    // 設置視窗大小
                    if (androidInterface?.setScreenSize) {
                        const { innerWidth, innerHeight } = window;
                        androidInterface.setScreenSize(innerWidth, innerHeight);
                    }
                    
                    // 禁用滾動回彈
                    document.body.style.overscrollBehavior = 'none';
                    document.documentElement.style.overscrollBehavior = 'none';
                    
                    // 禁用文字選擇
                    document.body.style.userSelect = 'none';
                    document.body.style.webkitUserSelect = 'none';
                    
                    // 禁用縮放
                    document.body.style.touchAction = 'none';
                }

                // 先初始化地圖
                Debug.log('初始化地圖');
                initializeMap();
                
                // 初始化 UI 處理
                Debug.log('初始化 UI');
                initializeUIHandlers();
                
                // 添加無地震速報提示
                const noAlertMessage = document.createElement('div');
                noAlertMessage.className = 'no-alert-message';
                noAlertMessage.id = 'no-alert-message';
                noAlertMessage.textContent = '目前無地震速報';
                document.body.appendChild(noAlertMessage);
                
                // 檢查登入狀態
                Debug.log('檢查登入狀態');
                if (!checkLoginStatus()) {
                    document.getElementById('login-overlay').style.display = 'flex';
                    return;
                }

                // 載入保存的設置
                showPGAValue = localStorage.getItem('showPGAValue') === 'true';
                
                // 獲取測站資料
                Debug.log('獲取測站資料');
                await fetchStations();
                
                // 開始 EEW 檢查
                Debug.log('啟動 EEW 檢查');
                startEEWChecking();
            } catch (error) {
                Debug.error('初始化失敗: ' + error);
                
                // 重試機制
                setTimeout(() => {
                    Debug.log('嘗試重新初始化', 'warning');
                    initialize();
                }, 5000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM 加載完成，開始初始化');
            initialize();
        });

        // EEW 檢查間隔（毫秒）
        const EEW_CHECK_INTERVAL = 1000;

        // 修改 startEEWChecking 函數
        function startEEWChecking() {
            const checkEEW = async () => {
                if (isTestMode) return;
                
                try {
                    const startTime = performance.now();
                    let hasValidEEW = false;
                    
                    // 檢查主要來源
                    try {
                        const response = await fetch('https://lb-1.exptech.dev/api/v2/eq/eew');
                        const data = await response.json();
                        if (Array.isArray(data) && data.length > 0) {
                            const eew = data[0];
                            if (eew && eew.eq && eew.eq.time) {
                                const eewTime = new Date(eew.eq.time).getTime();
                                const currentTime = Date.now();
                                if (currentTime - eewTime <= 5 * 60 * 1000) {
                                    showEEWAlert(eew);
                                    hasValidEEW = true;
                                }
                            }
                        }
                    } catch (error) {
                        Debug.error('主要來源獲取失敗: ' + error.message);
                    }

                    // 檢查備用來源
                    try {
                        const response = await fetch('https://x-flight-together.github.io/RealTech_EEW_Server/live_eew.json');
                const data = await response.json();
                        if (Array.isArray(data) && data.length > 0) {
                            const eew = data[0];
                            if (eew && eew.eq && eew.status === 1) {
                                showEEWAlert(eew);
                                hasValidEEW = true;
                            }
                        }
            } catch (error) {
                        Debug.error('備用來源獲取失敗: ' + error.message);
                    }

                    // 如果沒有有效的地震警報，顯示無地震速報
                    if (!hasValidEEW) {
                        clearExistingLayers();
                        const alertContainer = document.getElementById('alert-container');
                        if (alertContainer) {
                            alertContainer.innerHTML = '';
                        }
                        const eqInfo = document.getElementById('earthquake-info');
                        if (eqInfo) {
                            eqInfo.style.display = 'none';
                        }
                        const noAlertMessage = document.getElementById('no-alert-message');
                        if (noAlertMessage) {
                            noAlertMessage.style.display = 'block';
                        }
                    }

                    const endTime = performance.now();
                    currentPing = Math.round(endTime - startTime);
                    lastPingTime = Date.now();

                } catch (error) {
                    Debug.error('EEW 檢查失敗: ' + error.message);
                }
            };

            // 立即執行第一次檢查
            checkEEW();
            // 設置定時器
            setInterval(checkEEW, 1000);
        }

        // 修改 startWaveAnimation 函數
        function startWaveAnimation(eq) {
            // 清除現有的波動圈
            clearExistingLayers();

            const epicenter = [eq.lat, eq.lon];
            const depth = parseFloat(eq.depth) || 10;
            
            // P波和S波的速度 (km/s)
            const pSpeed = 6.5;  // P波速度
            const sSpeed = 3.5;  // S波速度
            const pSpeedMeters = pSpeed * 1000;
            const sSpeedMeters = sSpeed * 1000;

            // 創建 P 波圈（藍色）
            pWaveCircle = L.circle(epicenter, {
                radius: 0,
                color: '#00ffff',
                fillColor: '#00ffff',
                fillOpacity: 0.2,
                weight: 2,
                dashArray: '5, 10'
            }).addTo(map);

            // 創建 S 波圈（紅色）
            sWaveCircle = L.circle(epicenter, {
                radius: 0,
                color: '#ff0000',
                fillColor: '#ff0000',
                fillOpacity: 0.1,
                weight: 2,
                dashArray: '5, 10'
            }).addTo(map);

            map.setView(epicenter, 8);

            const startTime = Date.now();
            waveAnimationInterval = setInterval(() => {
                const elapsedSeconds = (Date.now() - startTime) / 1000;
                const pDistance = pSpeedMeters * elapsedSeconds;
                const sDistance = sSpeedMeters * elapsedSeconds;

                pWaveCircle.setRadius(pDistance);
                sWaveCircle.setRadius(sDistance);

                if (pDistance > 500000) {
                    clearInterval(waveAnimationInterval);
                    waveAnimationInterval = null;
                    clearExistingLayers();
                }
            }, 100);
        }

        // 修改 calculateWaveSpeed 函數
        function calculateWaveSpeed(depth) {
            // P波速度約為6-8km/s，根據深度調整
            const baseSpeed = 7000; // 基礎速度（米/秒）
            const depthFactor = Math.min(1.2, 1 + (depth / 100)); // 深度調整因子
            const pSpeed = baseSpeed * depthFactor;
            return { pSpeed };
        }

        // 修改 clearExistingLayers 函數
        function clearExistingLayers() {
            if (waveAnimationInterval) {
                clearInterval(waveAnimationInterval);
                waveAnimationInterval = null;
            }
            if (pWaveCircle) {
                map.removeLayer(pWaveCircle);
                pWaveCircle = null;
            }
            if (sWaveCircle) {
                map.removeLayer(sWaveCircle);
                sWaveCircle = null;
            }
            if (intensityLayer) {
                map.removeLayer(intensityLayer);
                intensityLayer = null;
            }
        }

        // 修改 updateIntensityArea 函數
        function updateIntensityArea(eq) {
            if (!eq || !eq.area) return;

            // 清除現有的震度圖層
            if (intensityLayer) {
                map.removeLayer(intensityLayer);
            }

            intensityLayer = L.layerGroup();

            // 定義震度區域的顏色和樣式
            const intensityStyles = {
                '5': { color: '#FF0000', fillColor: '#FF0000', weight: 3 },  // 紅色
                '4': { color: '#FFA500', fillColor: '#FFA500', weight: 2 },  // 橙色
                '3': { color: '#32CD32', fillColor: '#32CD32', weight: 2 }   // 綠色
            };

            // 先按震度大小排序，確保較大震度的區域在上層
            const sortedIntensities = Object.entries(eq.area)
                .sort(([a], [b]) => parseInt(b) - parseInt(a));

            // 添加震央標記
            const epicenterIcon = L.divIcon({
                html: '<div style="color: red; font-size: 24px; font-weight: bold;">×</div>',
                className: 'epicenter-marker',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });

            L.marker([eq.lat, eq.lon], { icon: epicenterIcon }).addTo(intensityLayer);

            // 為每個震度等級創建矩形區域
            for (const [intensity, areas] of sortedIntensities) {
                if (intensityStyles[intensity]) {
                    const bounds = calculateAreaBounds(eq.lat, eq.lon, intensity);
                    const rectangle = L.rectangle(bounds, {
                        ...intensityStyles[intensity],
                        fillOpacity: 0.3,
                        opacity: 0.9,
                        className: `intensity-${intensity}`
                    });
                    intensityLayer.addLayer(rectangle);
                }
            }

            intensityLayer.addTo(map);

            // 調整地圖視圖
            const bounds = intensityLayer.getBounds();
            map.fitBounds(bounds, {
                padding: [50, 50],
                maxZoom: 8
            });
        }

        // 修改 calculateAreaBounds 函數
        function calculateAreaBounds(lat, lon, intensity) {
            // 根據震度等級調整範圍大小
            const size = {
                '5': 0.4,  // 最大範圍
                '4': 0.3,  // 較大範圍
                '3': 0.25  // 中等範圍
            }[intensity] || 0.2;
            
            return [
                [lat - size, lon - size],
                [lat + size, lon + size]
            ];
        }

        function devLog(message, type = 'info') {
            if (!isDevMode) return;
            
            const output = document.getElementById('dev-output');
            const line = document.createElement('div');
            line.className = `dev-output-line ${type}`;
            
            const timestamp = new Date().toLocaleTimeString('zh-TW', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            line.textContent = `[${timestamp}] ${message}`;
            output.appendChild(line);
            
            // 保持滾動到最新的消息
            output.scrollTop = output.scrollHeight;
            
            // 限制顯示的行數
            while (output.children.length > 50) {
                output.removeChild(output.firstChild);
            }

            // 5秒後自動清除非錯誤消息
            if (type !== 'error') {
                setTimeout(() => {
                    if (line && line.parentNode) {
                        line.remove();
                    }
                }, 5000);
            }
        }

        // 檢查登入狀態
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('current-user').textContent = currentUser.username;
                if (!currentUser.isAdmin) {
                    // 非管理員隱藏開發者模式選項
                    const devModeOption = document.querySelector('.settings-item:has(#dev-mode-toggle)');
                    if (devModeOption) {
                        devModeOption.style.display = 'none';
                    }
                }
                return true;
            }
            return false;
        }

        // 登入函數
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('login-error');

            if (!username || !password) {
                errorElement.textContent = '請輸入帳號和密碼';
                errorElement.style.display = 'block';
                    return;
                }

            if (users[username] && users[username].password === password) {
                currentUser = {
                    username: username,
                    isAdmin: users[username].isAdmin
                };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('current-user').textContent = username;
                errorElement.style.display = 'none';

                // 處理開發者模式權限
                if (!currentUser.isAdmin) {
                    const devModeOption = document.querySelector('.settings-item:has(#dev-mode-toggle)');
                    if (devModeOption) {
                        devModeOption.style.display = 'none';
                    }
                    // 關閉開發者模式
                    document.getElementById('dev-mode-toggle').checked = false;
                    document.getElementById('dev-output').classList.remove('show');
                    localStorage.setItem('devMode', 'false');
                }

                initialize(); // 初始化應用
            } else {
                errorElement.textContent = '帳號或密碼錯誤';
                errorElement.style.display = 'block';
                document.getElementById('password').value = '';
            }
        }

        // 登出函數
        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('current-user').textContent = '-';
            
            // 清除地圖和數據
            clearExistingLayers();
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            // 重置其他狀態...
        }

        // 修改 showEEWAlert 函數
        function showEEWAlert(eew) {
            if (!eew || !eew.eq) return;

            const alertId = `eew-${eew.id}`;
            if (document.getElementById(alertId)) return;

            clearExistingLayers();
            
            try {
                startWaveAnimation(eew.eq);
                updateIntensityArea(eew.eq);
                
                // 播放警報音效
                playAlertSound();
                
                // 創建和顯示警報框
                const alertContainer = document.getElementById('alert-container');
                if (!alertContainer) return;

            const alertBox = document.createElement('div');
            alertBox.className = 'alert-box';
            alertBox.id = alertId;
                
                const eqTime = new Date(parseInt(eew.eq.time));
                const timeDiff = Math.floor((Date.now() - eqTime) / 1000);
                const formattedTime = `${String(eqTime.getHours()).padStart(2, '0')}:${String(eqTime.getMinutes()).padStart(2, '0')}`;

                // 處理區域資訊
                let areaInfo = '';
                if (eew.eq.area) {
                    areaInfo = Object.entries(eew.eq.area)
                        .map(([intensity, areas]) => {
                            if (Array.isArray(areas)) {
                                return `${intensity}級: ${areas.join(', ')}`;
                            }
                            return `${intensity}級: ${areas}`;
                        })
                        .join(' | ');
                }
            
            alertBox.innerHTML = `
                    <div class="alert-intensity">
                        <div class="alert-intensity-value">${eew.eq.max || '?'}</div>
                        <div class="alert-intensity-label">預估震度</div>
                    </div>
                <div class="alert-content">
                        <div class="alert-location">${eew.eq.loc || '位置未知'}</div>
                        <div class="alert-details">
                            規模 ${eew.eq.mag} / 深度 ${eew.eq.depth || '?'}km<br>
                            ${areaInfo ? `預估震度: ${areaInfo}` : ''}
                </div>
                        <div class="alert-time">
                            ${formattedTime} (${timeDiff}秒前) - ${eew.final ? '最終報' : `第${eew.serial || 1}報`}
                        </div>
                    </div>
            `;
            
            alertContainer.appendChild(alertBox);
            
                // 顯示地震資訊面板
                const eqInfo = document.getElementById('earthquake-info');
                const eqDetails = document.getElementById('earthquake-info-details');
                if (eqInfo && eqDetails) {
                    eqDetails.innerHTML = `
                        ${eew.eq.loc || '位置未知'} M${eew.eq.mag} 地震 | 深度 ${eew.eq.depth || '?'}km<br>
                        最大預估震度 ${eew.eq.max || '?'}級
                    `;
                    eqInfo.style.display = 'block';
                }
                
                // 隱藏無警報提示
                const noAlertMessage = document.getElementById('no-alert-message');
                if (noAlertMessage) {
                    noAlertMessage.style.display = 'none';
                }
            } catch (error) {
                Debug.error('顯示 EEW 警報失敗: ' + error.message);
            }
        }

        // 修改 playAlertSound 函數
        function playAlertSound() {
            try {
                if (isWebView && androidInterface?.playSound) {
                    androidInterface.playSound();
                } else {
                    const audio = new Audio('https://github.com/ExpTechTW/DPIP/raw/refs/heads/main/android/app/src/main/res/raw/warn.ogg');
                    audio.volume = 0.5;
                    // 在用戶互動時播放
                    const playPromise = audio.play();
                    if (playPromise) {
                        playPromise.catch(() => {
                            document.addEventListener('click', () => audio.play(), { once: true });
                        });
                    }
                }
            } catch (error) {
                Debug.error('音效播放失敗: ' + error.message);
                devLog('音效播放失敗: ' + error.message, 'error');
            }
        }

        // 添加計算距離的函數
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // 地球半徑（公里）
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // 添加 WebView 錯誤處理
        window.onerror = function(msg, url, line, col, error) {
            Debug.error(`WebView 錯誤: ${msg} (${url}:${line}:${col})`);
            if (isWebView && androidInterface?.onError) {
                androidInterface.onError(msg);
            }
            return false;
        };

        // 添加網絡狀態監控
        window.addEventListener('online', () => {
            Debug.log('網絡已連接');
            if (isWebView && androidInterface?.onNetworkChange) {
                androidInterface.onNetworkChange(true);
            }
        });

        window.addEventListener('offline', () => {
            Debug.log('網絡已斷開', 'warning');
            if (isWebView && androidInterface?.onNetworkChange) {
                androidInterface.onNetworkChange(false);
            }
        });
    </script>
</body>
</html>
